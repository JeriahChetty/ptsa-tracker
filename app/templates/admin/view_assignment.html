{% extends "base.html" %}
{% block title %}Assignment Details Â· PTSA Tracker{% endblock %}

{% block head %}
{{ super() }}
<style>
  .assignment-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    margin-bottom: 20px;
  }
  
  .assignment-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 20px;
    border-radius: 8px 8px 0 0;
  }
  
  .urgency-indicator {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .urgency-1 { background-color: #d4edda; color: #155724; }
  .urgency-2 { background-color: #fff3cd; color: #856404; }
  .urgency-3 { background-color: #f8d7da; color: #721c24; }
  
  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .status-active { background-color: #e3f2fd; color: #1976d2; }
  .status-completed { background-color: #e8f5e8; color: #2e7d32; }
  .status-paused { background-color: #fff3e0; color: #f57c00; }
  .status-cancelled { background-color: #ffebee; color: #d32f2f; }
  
  .progress-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
  }
  
  .step-card {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 10px;
    background: white;
    transition: box-shadow 0.2s;
  }
  
  .step-card:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .step-header {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .step-number {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background-color: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 12px;
  }
  
  .step-completed .step-number {
    background-color: #28a745;
  }
  
  .timeline-connector {
    width: 2px;
    height: 20px;
    background-color: #dee2e6;
    margin-left: 14px;
  }
  
  .timeline-connector.completed {
    background-color: #28a745;
  }
  
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }
  
  .detail-item {
    background: white;
    padding: 15px;
    border-radius: 6px;
    border-left: 4px solid #007bff;
  }
  
  .detail-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 5px;
  }
  
  .detail-value {
    font-weight: 500;
    color: #495057;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <div>
    <h2 class="mb-0">Assignment Details</h2>
    <p class="text-muted mb-0">View measure assignment progress and details</p>
  </div>
  <div>
    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-secondary me-2">
      <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
    </a>
    {% if assignment.status == 'active' %}
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#updateStatusModal">
      <i class="fas fa-edit me-1"></i>Update Status
    </button>
    {% endif %}
  </div>
</div>

<!-- Assignment Overview Card -->
<div class="assignment-card">
  <div class="assignment-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h3 class="mb-2">{{ assignment.measure.name }}</h3>
        <p class="mb-2 opacity-75">{{ assignment.company.name }}</p>
        <div class="d-flex align-items-center gap-3">
          <span class="urgency-indicator urgency-{{ assignment.urgency }}">
            {% if assignment.urgency == 1 %}Low Priority
            {% elif assignment.urgency == 2 %}Normal Priority  
            {% elif assignment.urgency == 3 %}High Priority
            {% endif %}
          </span>
          <span class="status-badge status-{{ assignment.status }}">
            {{ assignment.status|title }}
          </span>
        </div>
      </div>
      <div class="col-md-4 text-md-end">
        {% set completed_steps = assignment.assignment_steps|selectattr('status', 'equalto', 'completed')|list|length %}
        {% set total_steps = assignment.measure.steps|length %}
        {% if total_steps > 0 %}
        <div class="mb-2">
          <small class="opacity-75">Progress</small>
          <div class="h4 mb-0">{{ "%.0f"|format((completed_steps / total_steps) * 100) }}%</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Assignment Details -->
  <div class="card-body">
    {% if assignment.measure.measure_detail %}
    <div class="mb-4">
      <h6 class="text-secondary mb-2">Description</h6>
      <p class="text-muted">{{ assignment.measure.measure_detail }}</p>
    </div>
    {% endif %}
    
    <!-- Details Grid -->
    <div class="details-grid">
      <div class="detail-item">
        <div class="detail-label">Assigned Date</div>
        <div class="detail-value">{{ assignment.assigned_date.strftime('%B %d, %Y') if assignment.assigned_date else 'Not set' }}</div>
      </div>
      
      <div class="detail-item">
        <div class="detail-label">Due Date</div>
        <div class="detail-value">{{ assignment.end_date.strftime('%B %d, %Y') if assignment.end_date else 'Not set' }}</div>
      </div>
      
      {% if assignment.measure.target %}
      <div class="detail-item">
        <div class="detail-label">Target</div>
        <div class="detail-value">{{ assignment.measure.target }}</div>
      </div>
      {% endif %}
      
      {% if assignment.measure.responsible %}
      <div class="detail-item">
        <div class="detail-label">Responsible</div>
        <div class="detail-value">{{ assignment.measure.responsible }}</div>
      </div>
      {% endif %}
      
      {% if assignment.measure.departments %}
      <div class="detail-item">
        <div class="detail-label">Departments</div>
        <div class="detail-value">{{ assignment.measure.departments }}</div>
      </div>
      {% endif %}
      
      {% if assignment.measure.participants %}
      <div class="detail-item">
        <div class="detail-label">Participants</div>
        <div class="detail-value">{{ assignment.measure.participants }}</div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Progress Section -->
{% if assignment.measure.steps %}
<div class="progress-section">
  <h5 class="mb-3">
    <i class="fas fa-tasks me-2"></i>Implementation Steps
    {% if assignment.assignment_steps %}
    <small class="text-muted">({{ assignment.assignment_steps|selectattr('status', 'equalto', 'completed')|list|length }} of {{ assignment.measure.steps|length }} completed)</small>
    {% endif %}
  </h5>
  
  <div class="steps-timeline">
    {% for step in assignment.measure.steps|sort(attribute='step') %}
      {% set assignment_step = assignment.assignment_steps|selectattr('measure_step_id', 'equalto', step.id)|first %}
      {% set is_completed = assignment_step and assignment_step.status == 'completed' %}
      
      <div class="step-card {% if is_completed %}step-completed{% endif %}">
        <div class="step-header">
          <div class="step-number">{{ step.step }}</div>
          <div class="flex-grow-1">
            <h6 class="mb-1">{{ step.title }}</h6>
            {% if is_completed %}
            <small class="text-success">
              <i class="fas fa-check-circle me-1"></i>Completed
              {% if assignment_step.completed_date %}
              on {{ assignment_step.completed_date.strftime('%B %d, %Y') }}
              {% endif %}
            </small>
            {% else %}
            <small class="text-muted">Pending</small>
            {% endif %}
          </div>
        </div>
        
        {% if step.description %}
        <p class="text-muted mb-2 ms-5">{{ step.description }}</p>
        {% endif %}
        
        {% if assignment_step and assignment_step.notes %}
        <div class="ms-5 mt-2">
          <small class="text-info">
            <i class="fas fa-sticky-note me-1"></i>Notes: {{ assignment_step.notes }}
          </small>
        </div>
        {% endif %}
      </div>
      
      {% if not loop.last %}
      <div class="timeline-connector {% if is_completed %}completed{% endif %}"></div>
      {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Company Information -->
<div class="card">
  <div class="card-header">
    <h6 class="mb-0">
      <i class="fas fa-building me-2"></i>Company Information
    </h6>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <strong>Company:</strong> {{ assignment.company.name }}<br>
        <strong>Region:</strong> {{ assignment.company.region or 'Not specified' }}<br>
        <strong>Industry:</strong> {{ assignment.company.industry_category or 'Not specified' }}
      </div>
      <div class="col-md-6">
        <strong>Tech Resources:</strong> {{ assignment.company.tech_resources or 'Not specified' }}<br>
        <strong>Human Resources:</strong> {{ assignment.company.human_resources or 'Not specified' }}<br>
        <strong>Membership:</strong> {{ assignment.company.membership or 'Not specified' }}
      </div>
    </div>
  </div>
</div>

<!-- Update Status Modal -->
{% if assignment.status == 'active' %}
<div class="modal fade" id="updateStatusModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('admin.update_assignment_status', assignment_id=assignment.id) }}">
        <div class="modal-header">
          <h5 class="modal-title">Update Assignment Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" name="status" id="status" required>
              <option value="active" {% if assignment.status == 'active' %}selected{% endif %}>Active</option>
              <option value="completed">Completed</option>
              <option value="paused">Paused</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="notes" class="form-label">Notes (optional)</label>
            <textarea class="form-control" name="notes" id="notes" rows="3" placeholder="Add any notes about this status change..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Status</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}