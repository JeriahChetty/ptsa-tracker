{% extends "base.html" %}
{% block title %}Add New Measures Â· PTSA Tracker{% endblock %}

{% block head %}
{{ super() }}
<style>
.step-number {
    min-width: 60px !important;
    font-size: 0.875rem !important;
    white-space: nowrap !important;
    padding: 0.35rem 0.65rem !important;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
  <h2 class="mb-0">Create & Assign Measures</h2>
  <a class="btn btn-outline-secondary" href="{{ url_for('admin.companies') }}">Back to Companies</a>
</div>

<div class="alert alert-info" role="status">
    Creating measures for: <strong>{{ company.name }}</strong>
</div>

<form method="POST" action="{{ url_for('admin.company_measures_wizard', company_id=company.id) }}" enctype="multipart/form-data" id="wizard-form" novalidate>

    <div id="measures-container" class="d-grid gap-3">
        <!-- One measure block to start with -->
        <div class="card measure-block" draggable="true">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0 measure-title">Measure 1</h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-measure">Delete</button>
                </div>

                <!-- Measure fields -->
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="m-0-name" class="form-label">Measure name</label>
                        <input id="m-0-name" name="measures[0][name]" class="form-control" required placeholder="e.g., Implement 5S in Toolroom">
                    </div>

                    <div class="col-md-6">
                        <label for="m-0-target" class="form-label">Target / Objective</label>
                        <input id="m-0-target" name="measures[0][target]" class="form-control" placeholder="e.g., Reduce changeover by 20%">
                    </div>

                    <div class="col-12">
                        <label for="m-0-measure_detail" class="form-label">Measure Detail</label>
                        <textarea id="m-0-measure_detail" name="measures[0][measure_detail]" class="form-control" rows="2" placeholder="Short summary"></textarea>
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-departments" class="form-label">Departments</label>
                        <input id="m-0-departments" name="measures[0][departments]" class="form-control" placeholder="e.g., Toolroom, QA">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-responsible" class="form-label">Responsible</label>
                        <input id="m-0-responsible" name="measures[0][responsible]" class="form-control" placeholder="e.g., Maintenance Lead">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-participants" class="form-label">Participants</label>
                        <input id="m-0-participants" name="measures[0][participants]" class="form-control" placeholder="Names or teams">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-urgency" class="form-label">Priority/Urgency</label>
                        <select id="m-0-urgency" name="measures[0][urgency]" class="form-select">
                            <option value="1">Low (1)</option>
                            <option value="2" selected>Normal (2)</option>
                            <option value="3">High (3)</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-start-date" class="form-label">Start Date</label>
                        <input id="m-0-start-date" name="measures[0][start_date]" type="date" class="form-control date-input">
                    </div>

                    <div class="col-md-4">
                        <label for="m-0-end-date" class="form-label">End Date</label>
                        <input id="m-0-end-date" name="measures[0][end_date]" type="date" class="form-control date-input">
                        <div class="days-display mt-1 text-muted small"></div>
                    </div>
                </div>

                <hr>

                <!-- Steps Section -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Procedure</h6>
                    <button type="button" class="btn btn-sm btn-outline-primary add-step">Add Step</button>
                </div>

                <div class="steps-container d-grid gap-2">
                    <!-- Initial step item -->
                    <div class="step-item border rounded p-2">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-12">
                                <label for="m-0-s-0-title" class="form-label">Steps</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input id="m-0-s-0-title" name="measures[0][steps][0][title]" class="form-control" placeholder="e.g., Sort (Seiri)">
                                    <span class="badge bg-primary step-number" style="min-width: 60px; font-size: 0.875rem;">Step 1</span>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="m-0-s-0-file" class="form-label">Add Image (when applicable)</label>
                                <input id="m-0-s-0-file" name="measures[0][steps][0][files][]" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2">
        <button type="button" id="add-measure" class="btn btn-secondary">Add Another Measure</button>
        <button type="submit" class="btn btn-success">Create & Assign Measures</button>
    </div>
</form>

<!-- Hidden templates -->
<template id="tpl-measure">
    <div class="card measure-block">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="card-title mb-0 measure-title">Measure</h5>
                <button type="button" class="btn btn-sm btn-outline-danger remove-measure">Delete</button>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Measure name</label>
                    <input name="measures[0][name]" class="form-control" required placeholder="e.g., Implement 5S in Toolroom">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Target / Objective</label>
                    <input name="measures[0][target]" class="form-control" placeholder="e.g., Reduce changeover by 20%">
                </div>

                <div class="col-12">
                    <label class="form-label">Measure Detail</label>
                    <textarea name="measures[0][measure_detail]" class="form-control" rows="2" placeholder="Short summary"></textarea>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Departments</label>
                    <input name="measures[0][departments]" class="form-control" placeholder="e.g., Toolroom, QA">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Responsible</label>
                    <input name="measures[0][responsible]" class="form-control" placeholder="e.g., Maintenance Lead">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Participants</label>
                    <input name="measures[0][participants]" class="form-control" placeholder="Names or teams">
                </div>

                <div class="col-md-4">
                    <label class="form-label">Priority/Urgency</label>
                    <select name="measures[0][urgency]" class="form-select">
                        <option value="1">Low (1)</option>
                        <option value="2" selected>Normal (2)</option>
                        <option value="3">High (3)</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Start Date</label>
                    <input name="measures[0][start_date]" type="date" class="form-control date-input">
                </div>

                <div class="col-md-4">
                    <label class="form-label">End Date</label>
                    <input name="measures[0][end_date]" type="date" class="form-control date-input">
                    <div class="days-display mt-1 text-muted small"></div>
                </div>
            </div>

            <hr>

            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Procedure</h6>
                <button type="button" class="btn btn-sm btn-outline-primary add-step">Add Step</button>
            </div>

            <div class="steps-container d-grid gap-2">
                <div class="step-item border rounded p-2">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-12">
                            <label class="form-label">Steps</label>
                            <div class="d-flex align-items-center gap-2">
                                <input name="measures[0][steps][0][title]" class="form-control" placeholder="e.g., Set in Order (Seiton)">
                                <span class="badge bg-primary step-number" style="min-width: 60px; font-size: 0.875rem;">Step 1</span>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Add Image (when applicable)</label>
                            <input name="measures[0][steps][0][files][]" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
                        </div>
                        <div class="col-12 text-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<template id="tpl-step">
    <div class="step-item border rounded p-2">
        <div class="row g-2 align-items-end">
            <div class="col-md-12">
                <label class="form-label">Steps</label>
                <div class="d-flex align-items-center gap-2">
                    <input name="measures[0][steps][0][title]" class="form-control" placeholder="e.g., Shine (Seiso)">
                    <span class="badge bg-primary step-number" style="min-width: 60px; font-size: 0.875rem;">Step 1</span>
                </div>
            </div>

            <div class="col-12">
                <label class="form-label">Add Image (when applicable)</label>
                <input name="measures[0][steps][0][files][]" type="file" class="form-control" accept=".pdf,.png,.jpg,.jpeg,.webp" multiple>
            </div>
            <div class="col-12 text-end">
                <button type="button" class="btn btn-sm btn-outline-danger remove-step">Delete</button>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('measures-container');
    const addMeasureBtn = document.getElementById('add-measure');
    const tplMeasure = document.getElementById('tpl-measure');
    const tplStep = document.getElementById('tpl-step');
    const form = document.getElementById('wizard-form');
    const storageKey = 'ptsa_measures_form_{{ company.id }}';

    /**
     * Calculate and display days between start and end dates
     */
    function updateDaysDisplay(measureBlock) {
        const startInput = measureBlock.querySelector('input[name$="[start_date]"]');
        const endInput = measureBlock.querySelector('input[name$="[end_date]"]');
        const daysDisplay = measureBlock.querySelector('.days-display');
        
        if (startInput && endInput && daysDisplay && startInput.value && endInput.value) {
            const start = new Date(startInput.value);
            const end = new Date(endInput.value);
            const diffTime = end - start;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays >= 0) {
                daysDisplay.textContent = `Duration: ${diffDays} day${diffDays !== 1 ? 's' : ''}`;
                daysDisplay.classList.remove('text-danger');
                daysDisplay.classList.add('text-muted');
            } else {
                daysDisplay.textContent = 'End date must be after start date';
                daysDisplay.classList.remove('text-muted');
                daysDisplay.classList.add('text-danger');
            }
        } else if (daysDisplay) {
            daysDisplay.textContent = '';
        }
    }

    /**
     * Save form data to localStorage
     */
    function saveFormData() {
        const formData = {};
        const measures = [];
        
        container.querySelectorAll('.measure-block').forEach((block, mIdx) => {
            const measure = {};
            
            // Save all input, textarea, and select values
            block.querySelectorAll('input:not([type="file"]), textarea, select').forEach(field => {
                if (field.name) {
                    const match = field.name.match(/measures\[\d+\]\[(.+)\]/);
                    if (match) {
                        const fieldName = match[1].replace(/\[|\]/g, '_');
                        measure[fieldName] = field.value;
                    }
                }
            });
            
            measures.push(measure);
        });
        
        formData.measures = measures;
        formData.timestamp = new Date().toISOString();
        
        try {
            localStorage.setItem(storageKey, JSON.stringify(formData));
        } catch (e) {
            console.warn('Failed to save form data:', e);
        }
    }

    /**
     * Restore form data from localStorage
     */
    function restoreFormData() {
        try {
            const saved = localStorage.getItem(storageKey);
            if (!saved) return;
            
            const formData = JSON.parse(saved);
            if (!formData.measures || formData.measures.length === 0) return;
            
            // Ask user if they want to restore
            const timestamp = new Date(formData.timestamp);
            const confirm = window.confirm(
                `Found unsaved form data from ${timestamp.toLocaleString()}.\n\nWould you like to restore it?`
            );
            
            if (!confirm) {
                localStorage.removeItem(storageKey);
                return;
            }
            
            // Clear existing measures except first one
            const existingBlocks = container.querySelectorAll('.measure-block');
            for (let i = 1; i < existingBlocks.length; i++) {
                existingBlocks[i].remove();
            }
            
            // Restore each measure
            formData.measures.forEach((measure, mIdx) => {
                if (mIdx > 0) {
                    // Add new measure block
                    const newMeasure = tplMeasure.content.cloneNode(true);
                    container.appendChild(newMeasure);
                }
                
                const block = container.querySelectorAll('.measure-block')[mIdx];
                
                // Restore field values
                Object.keys(measure).forEach(key => {
                    const fieldName = key.replace(/_/g, '][').replace(/\]\[(\d+)\]\[/, '][steps][$1][');
                    const selector = `[name="measures[${mIdx}][${fieldName}]"]`;
                    const field = block.querySelector(selector);
                    
                    if (field && measure[key]) {
                        field.value = measure[key];
                    }
                });
            });
            
            reindex();
            
            // Update days displays
            container.querySelectorAll('.measure-block').forEach(block => {
                updateDaysDisplay(block);
            });
            
        } catch (e) {
            console.warn('Failed to restore form data:', e);
            localStorage.removeItem(storageKey);
        }
    }

    /**
     * Clear saved form data
     */
    function clearFormData() {
        localStorage.removeItem(storageKey);
    }

    /**
     * Reindexes all measure blocks and their steps to ensure proper form field naming
     * Updates measure titles, field names, IDs, and step numbers
     * This is crucial for proper form data submission
     */
    function reindex() {
        container.querySelectorAll('.measure-block').forEach((block, mIdx) => {
            block.querySelector('.measure-title').textContent = `Measure ${mIdx + 1}`;
            
            block.querySelectorAll('input, textarea, select').forEach(field => {
                const name = field.name || field.closest('[name]')?.name;
                if (!name) return;
                const match = name.match(/measures\[\d+\]\[(.+)\]/);
                if (match) {
                    field.name = `measures[${mIdx}][${match[1]}]`;
                    field.id = `m-${mIdx}-${match[1].replace(/\[|\]/g, '-')}`;
                }
            });

            block.querySelectorAll('.step-item').forEach((step, sIdx) => {
                step.querySelector('.step-number').textContent = `Step ${sIdx + 1}`;
                step.querySelectorAll('input').forEach(field => {
                    const isFile = field.type === 'file';
                    field.name = `measures[${mIdx}][steps][${sIdx}][${isFile ? 'files][]' : 'title]'}`;
                    field.id = `m-${mIdx}-s-${sIdx}-${isFile ? 'file' : 'title'}`;
                });
            });
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-step')) {
            e.preventDefault();
            const block = e.target.closest('.measure-block');
            const stepsContainer = block.querySelector('.steps-container');
            const newStep = tplStep.content.cloneNode(true);
            stepsContainer.appendChild(newStep);
            reindex();
        }
        else if (e.target.classList.contains('remove-step')) {
            e.preventDefault();
            const step = e.target.closest('.step-item');
            const stepsContainer = step.closest('.steps-container');
            if (stepsContainer.querySelectorAll('.step-item').length <= 1) {
                alert('Each measure must have at least one step.');
                return;
            }
            step.remove();
            reindex();
        }
        else if (e.target.classList.contains('remove-measure')) {
            e.preventDefault();
            if (container.querySelectorAll('.measure-block').length <= 1) {
                alert('You must have at least one measure.');
                return;
            }
            if (confirm('Are you sure you want to delete this measure?')) {
                e.target.closest('.measure-block').remove();
                reindex();
            }
        }
    });

    addMeasureBtn.addEventListener('click', function() {
        const newMeasure = tplMeasure.content.cloneNode(true);
        container.appendChild(newMeasure);
        reindex();
    });

    // Handle date changes for days calculation
    container.addEventListener('change', function(e) {
        if (e.target.classList.contains('date-input')) {
            const measureBlock = e.target.closest('.measure-block');
            updateDaysDisplay(measureBlock);
            saveFormData(); // Auto-save on change
        }
    });

    // Auto-save form data on any input change
    container.addEventListener('input', function(e) {
        if (e.target.matches('input, textarea, select')) {
            saveFormData();
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        let hasErrors = false;
        container.querySelectorAll('.measure-block').forEach((block, index) => {
            const nameInput = block.querySelector('input[name$="[name]"]');
            if (!nameInput || !nameInput.value.trim()) {
                hasErrors = true;
                alert(`Measure ${index + 1} must have a name.`);
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
        } else {
            // Clear saved data on successful submission
            clearFormData();
        }
    });

    // Initialize: restore saved data if exists
    restoreFormData();
    
    // Initial reindex and days calculation
    reindex();
    container.querySelectorAll('.measure-block').forEach(block => {
        updateDaysDisplay(block);
    });

    // Warn user before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
});
</script>
{% endblock %}
