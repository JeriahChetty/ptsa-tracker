{% extends "base.html" %}
{% block title %}Companies · PTSA Tracker{% endblock %}

{% block head %}
{{ super() }}
<style>
  .sidebar-form {
    position: fixed;
    left: 0;
    top: 56px; /* Below navbar */
    height: calc(100vh - 56px);
    width: 420px;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    z-index: 1000;
    transition: transform 0.3s ease-in-out;
    overflow-y: auto;
  }
  
  .sidebar-form.collapsed {
    transform: translateX(-100%);
  }
  
  .sidebar-toggle {
    position: fixed;
    left: 420px;
    top: 70px;
    z-index: 1001;
    transition: left 0.3s ease-in-out;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
  }
  
  .sidebar-toggle.collapsed {
    left: 0;
  }
  
  .main-content {
    margin-left: 440px;
    transition: margin-left 0.3s ease-in-out;
  }
  
  .main-content.expanded {
    margin-left: 20px;
  }
  
  .mh-220 {
    max-height: 220px;
  }
  
  .password-input-group {
    position: relative;
  }
  
  .password-toggle {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
    font-size: 16px;
    z-index: 10;
  }
  
  .password-toggle:hover {
    color: #495057;
  }
  
  .form-control.with-toggle {
    padding-right: 40px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Sidebar Form -->
<div class="sidebar-form p-4" id="sidebarForm">
  <h5 class="mb-3"><i class="fas fa-building me-2"></i>Add Company</h5>

        <form method="POST" action="{{ url_for('admin.companies') }}">
  <div class="mb-3">
    <label for="name" class="form-label">Company name</label>
    <input id="name" name="name" class="form-control" required placeholder="e.g., Acme Tooling">
  </div>

  <div class="mb-3">
    <label for="region" class="form-label">Region</label>
    <input id="region" name="region" class="form-control" placeholder="e.g., Gauteng">
  </div>

  <div class="mb-3">
    <label for="industry_category" class="form-label">Industry category</label>
    <input id="industry_category" name="industry_category" class="form-control" placeholder="e.g., Automotive">
  </div>

  <div class="mb-3">
    <label for="tech_resources" class="form-label">Tech resources</label>
    <textarea id="tech_resources" name="tech_resources" class="form-control" rows="2"
              placeholder="e.g., 2x 3-axis mills, wire EDM, 5-axis CNC, 3D scanner"></textarea>
  </div>

  <div class="mb-3">
    <label for="human_resources" class="form-label">Human resources</label>
    <textarea id="human_resources" name="human_resources" class="form-control" rows="2"
              placeholder="e.g., 8 toolmakers, 3 apprentices, 5 CNC operators"></textarea>
  </div>

  <div class="mb-3">
    <label for="membership" class="form-label">Membership</label>
    <select id="membership" name="membership" class="form-select">
      <option value="">— Select —</option>
      <option value="Member">Member</option>
      <option value="Non-member">Non-member</option>
    </select>
  </div>

  <div class="mb-3">
    <label for="phone" class="form-label">Phone number</label>
    <input id="phone" name="phone" class="form-control" placeholder="e.g., +27 11 123 4567">
  </div>

  <hr class="my-3">

  <h6 class="mb-2">Company Login (created by admin)</h6>
  <div class="mb-3">
    <label for="login_email" class="form-label">Login email</label>
    <input id="login_email" type="email" name="login_email" class="form-control" required
           placeholder="e.g., contact@acme.co.za">
  </div>
  <div class="mb-3">
    <label for="login_password" class="form-label">Enter password</label>
    <div class="password-input-group">
      <input id="login_password" type="password" name="login_password" class="form-control with-toggle" required
             placeholder="Enter password">
      <button type="button" class="password-toggle toggle-password" data-target="login_password" title="Show/hide password">
        <i class="fas fa-eye"></i>
      </button>
    </div>
  </div>
  <div class="mb-3">
    <label for="login_password_confirm" class="form-label">Confirm password</label>
    <div class="password-input-group">
      <input id="login_password_confirm" type="password" name="login_password_confirm" class="form-control with-toggle" required
             placeholder="Confirm password">
      <button type="button" class="password-toggle toggle-password" data-target="login_password_confirm" title="Show/hide password">
        <i class="fas fa-eye"></i>
      </button>
    </div>
  </div>

  <fieldset class="mb-3">
    <legend class="fs-6 mb-2">Assign measures now (optional)</legend>
    <div class="border rounded p-2 overflow-auto mh-220">
      {% if measures %}
        {% for m in measures %}
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="m-{{ m.id }}" name="assign_measure_ids" value="{{ m.id }}">
          <label class="form-check-label" for="m-{{ m.id }}">{{ m.name }}</label>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-muted small">No measures yet. Create some on the Measures page.</div>
      {% endif %}
    </div>
  </fieldset>

  <button type="submit" class="btn btn-primary w-100">
    <i class="fas fa-plus me-2"></i>Create company & login
  </button>
</form>
</div>

<!-- Toggle Button -->
<button class="btn btn-primary sidebar-toggle" id="sidebarToggle" title="Toggle form">
  <i class="fas fa-chevron-left"></i>
</button>

<!-- Main Content -->
<div class="main-content" id="mainContent">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="mb-0">Companies</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.measures') }}">Go to Measures</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('admin.measure_history') }}">Measures History</a>
    </div>
  </div>

  <!-- Companies table -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">All Companies</h5>

        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Region</th>
                <th scope="col">Category</th>
                <th scope="col">Tech Resources</th>
                <th scope="col">Membership</th>
                <th scope="col">Phone</th>
                <th scope="col" class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for c in companies %}
              <tr>
                <td>{{ c.name }}</td>
                <td>{{ c.region or '—' }}</td>
                <td>{{ c.industry_category or '—' }}</td>
                <td class="text-break small">
                  {{ c.tech_resources or '—' }}
                </td>
                <td>{{ c.membership or '—' }}</td>
                <td>{{ c.phone or '—' }}</td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Actions for {{ c.name }}">
                    <!-- View company profile -->
                    <a class="btn btn-outline-info"
                       href="{{ url_for('admin.company_profile', company_id=c.id) }}"
                       title="View company profile">
                      <i class="fas fa-eye me-1"></i>View
                    </a>
                    <!-- Edit company -->
                    <a class="btn btn-outline-primary"
                       href="{{ url_for('admin.edit_company', company_id=c.id) }}"
                       title="Edit company">
                      <i class="fas fa-edit me-1"></i>Edit
                    </a>
                    <!-- Assign existing measures (go to Measures page, optionally prefilter by company) -->
                    <a class="btn btn-outline-secondary"
                       href="{{ url_for('admin.measures', company_id=c.id) }}"
                       title="Assign existing measures">
                      <i class="fas fa-tasks me-1"></i>Assign
                    </a>
                    <!-- Delete company -->
                    <button type="button" class="btn btn-outline-danger delete-company-btn" 
                            data-company-id="{{ c.id }}"
                            data-company-name="{{ c.name }}"
                            title="Delete company">
                      <i class="fas fa-trash me-1"></i>Delete
                    </button>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="text-muted">No companies yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const sidebarForm = document.getElementById('sidebarForm');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mainContent = document.getElementById('mainContent');
  const toggleIcon = sidebarToggle.querySelector('i');
  
  // Load saved state from localStorage
  const isCollapsed = localStorage.getItem('companiesSidebarCollapsed') === 'true';
  if (isCollapsed) {
    sidebarForm.classList.add('collapsed');
    sidebarToggle.classList.add('collapsed');
    mainContent.classList.add('expanded');
    toggleIcon.className = 'fas fa-chevron-right';
  }
  
  sidebarToggle.addEventListener('click', function() {
    const isCurrentlyCollapsed = sidebarForm.classList.contains('collapsed');
    
    if (isCurrentlyCollapsed) {
      // Expand sidebar
      sidebarForm.classList.remove('collapsed');
      sidebarToggle.classList.remove('collapsed');
      mainContent.classList.remove('expanded');
      toggleIcon.className = 'fas fa-chevron-left';
      localStorage.setItem('companiesSidebarCollapsed', 'false');
    } else {
      // Collapse sidebar
      sidebarForm.classList.add('collapsed');
      sidebarToggle.classList.add('collapsed');
      mainContent.classList.add('expanded');
      toggleIcon.className = 'fas fa-chevron-right';
      localStorage.setItem('companiesSidebarCollapsed', 'true');
    }
  });
  
  // Password toggle functionality
  document.querySelectorAll('.toggle-password').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      const icon = this.querySelector('i');
      
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    });
  });
  
  // Form submission validation for password confirmation
  const form = sidebarForm.querySelector('form');
  if (form) {
    form.addEventListener('submit', function(e) {
      const password = document.getElementById('login_password').value;
      const confirmPassword = document.getElementById('login_password_confirm').value;
      
      if (password !== confirmPassword) {
        e.preventDefault();
        alert('Passwords do not match. Please try again.');
        return false;
      }
    });
  }
});

// Delete company function
document.querySelectorAll('.delete-company-btn').forEach(button => {
  button.addEventListener('click', function() {
    const companyId = this.dataset.companyId;
    const companyName = this.dataset.companyName;
    
    if (confirm(`Are you sure you want to delete ${companyName}? This action cannot be undone and will also delete all associated data including users, measures, and assignments.`)) {
      // Create a form and submit it
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/admin/companies/${companyId}/delete`;
      document.body.appendChild(form);
      form.submit();
    }
  });
});
</script>
{% endblock %}



